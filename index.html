<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Data Visualization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        body {
            background: linear-gradient(45deg, #ff9a9e, #fad0c4);
            transition: background 0.5s ease, color 0.5s ease;
            font-family: 'Poppins', sans-serif;
        }
        .dark-mode {
            background: #222;
            color: #fff;
        }
        h2 { text-shadow: 3px 3px 8px rgba(0,0,0,0.4); }
        .list-group-item { cursor: pointer; transition: all 0.3s ease-in-out; }
        .list-group-item:hover { transform: scale(1.1); background: #ff6f61; }
        canvas { background: #fff; border-radius: 10px; }
        .theme-toggle, .download-btn { background: #ff6f61; color: white; border: none; padding: 10px 15px; }
        .loading { display: none; font-size: 18px; }
    </style>
</head>
<body class="container mt-4">
    <!-- Button to toggle dark mode -->
    <button class="theme-toggle" onclick="toggleTheme()">üåô Toggle Theme</button>
    <!-- Title of the page -->
    <h2 class="text-center">üìä Stock Data Visualization</h2>
    <!-- Input fields to filter data by date -->
    <input type="date" id="startDate"> <input type="date" id="endDate"> <button onclick="filterByDate()">Apply</button>
    <!-- Input field to search for a company -->
    <input type="text" id="searchBar" class="form-control mb-3" placeholder="üîç Search Company..." onkeyup="filterCompanies()">
    <!-- Row to display company list and chart -->
    <div class="row">
        <!-- Column to display company list -->
        <div class="col-md-4">
            <ul id="companyList" class="list-group"></ul>
        </div>
        <!-- Column to display chart -->
        <div class="col-md-8">
            <canvas id="stockChart"></canvas>
            <!-- Button to download chart -->
            <button class="download-btn" onclick="downloadChart()">üì• Download Chart</button>
        </div>
    </div>
    <!-- Loading indicator -->
    <div class="loading" id="loading">‚è≥ Loading...</div>
    <script>
        // Variable to store company data
        let companyData = {};
        // Variable to store chart instance
        let stockChart;
        const ctx = document.getElementById("stockChart").getContext("2d");
        fetch('https://raw.githubusercontent.com/shaktids/stock_app_test/main/dump.csv')
            .then(response => response.text())
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true, skipEmptyLines: true,
                    complete: results => processCSV(results.data)
                });
            });
        function processCSV(data) {
            companyData = {}; document.getElementById("companyList").innerHTML = "";
            data.forEach(row => {
                const company = row.index_name;
                if (!companyData[company]) companyData[company] = [];
                companyData[company].push({
                    date: row.index_date,
                    open: parseFloat(row.open_index_value),
                    high: parseFloat(row.high_index_value),
                    low: parseFloat(row.low_index_value),
                    close: parseFloat(row.closing_index_value)
                });
            });
            Object.keys(companyData).forEach(company => {
                let li = document.createElement("li");
                li.textContent = company; li.classList.add("list-group-item");
                li.onclick = () => drawChart(company);
                document.getElementById("companyList").appendChild(li);
            });
        }
        function drawChart(company) {
            const data = companyData[company];
            const labels = data.map(item => item.date);
            const openValues = data.map(item => item.open);
            const highValues = data.map(item => item.high);
            const lowValues = data.map(item => item.low);
            const closeValues = data.map(item => item.close);
            if (stockChart) stockChart.destroy();
            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: `Open`, data: openValues, borderColor: "#ffcc00", borderWidth: 2 },
                        { label: ` High`, data: highValues, borderColor: "#ff5733", borderWidth: 2 },
                        { label: ` Low`, data: lowValues, borderColor: "#33b5e5", borderWidth: 2 },
                        { label: ` Close`, data: closeValues, borderColor: "#2ecc71", borderWidth: 2 }
                    ]
                },
                options: { responsive: true, scales: { x: { ticks: { color: "#fff" } }, y: { ticks: { color: "#fff" } } } }
            });
        }
        function filterCompanies() {
            let filter = document.getElementById("searchBar").value.toUpperCase();
            let items = document.getElementById("companyList").getElementsByTagName("li");
            for (let i = 0; i < items.length; i++) {
                let txtValue = items[i].textContent || items[i].innerText;
                items[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }
        }
        function toggleTheme() { document.body.classList.toggle("dark-mode"); }
        function downloadChart() {
            let link = document.createElement('a');
            link.href = stockChart.toBase64Image();
            link.download = 'stock_chart.png';
            link.click();
        }
        function filterByDate() {
            let startDate = document.getElementById("startDate").value;
            let endDate = document.getElementById("endDate").value;
            alert(`Filtering from ${startDate} to ${endDate}`); // Implement filtering logic
        }
    </script>
</body>
</html>
